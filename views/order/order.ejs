<%- include('../partials/header') %>

<style>
  .container {
      text-align: center;
  }
  .table th, .table td {
      text-align: center !important;
      vertical-align: middle !important;
  }
  h3, h4 {
      text-align: center;
  }
  #tableContainer {
      text-align: center;
  }
</style>

<div class="container mt-4 d-flex">
  <div id="menuContainer" class="flex-grow-1">
    <h3>
      üìú Menu - <span id="selectedTable">Ch·ªçn b√†n</span>
    </h3>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead class="table-dark">
          <tr>
            <th>Lo·∫°i m√≥n</th>
            <th>T√™n m√≥n</th>
            <th>Gi√° (VND)</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>Ch·ªçn</th>
          </tr>
        </thead>
        <tbody id="menuTableBody">
          <tr>
            <td colspan="5" class="text-danger">
              Vui l√≤ng ch·ªçn b√†n ƒë·ªÉ hi·ªÉn th·ªã menu.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="tableContainer" class="d-grid gap-2 ms-auto" 
       style="display: grid; grid-template-columns: repeat(2, 1fr); width: 200px">
    <h4 style="grid-column: span 2">ü™ë Ch·ªçn b√†n</h4>
    <% for (let i = 1; i <= 20; i++) { %>
    <button class="btn btn-outline-primary table-btn" data-table="<%= i %>">
      B√†n <%= i %>
    </button>
    <% } %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".table-btn").forEach((button) => {
        button.addEventListener("click", function () {
            const tableNumber = this.getAttribute("data-table");
            document.getElementById("selectedTable").innerText = `B√†n ${tableNumber}`;

            fetch(`/order/menu/${tableNumber}`)
                .then((response) => response.json())
                .then((data) => {
                    renderMenu(data, tableNumber);
                })
                .catch((error) => console.error("L·ªói t·∫£i menu:", error));
        });
    });

    function renderMenu(menuItems, tableNumber) {
        const menuTable = document.getElementById("menuTableBody");
        menuTable.innerHTML = "";

        if (!Array.isArray(menuItems) || menuItems.length === 0) {
            menuTable.innerHTML = `<tr><td colspan='5' class='text-danger'>‚ùå Kh√¥ng c√≥ m√≥n n√†o trong menu.</td></tr>`;
            return;
        }

        menuItems.forEach((item) => {
            menuTable.innerHTML += `
                <tr>
                    <td>${item.category}</td>
                    <td>${item.name}</td>
                    <td class="fw-bold">${item.price.toLocaleString('vi-VN')} VND</td>
                    <td class="d-flex justify-content-center">
                        <input type="number" class="form-control text-center quantity" min="1" value="1" data-id="${item._id}" style="width: 80px;">
                    </td>
                    <td>
                        <button class="btn btn-success add-to-cart" data-id="${item._id}" 
                                data-name="${item.name}" data-price="${item.price}" data-table="${tableNumber}">
                            ‚ûï Th√™m
                        </button>
                    </td>
                </tr>`;
        });

        document.querySelectorAll(".add-to-cart").forEach((button) => {
            button.addEventListener("click", function () {
                const itemId = this.getAttribute("data-id");
                const tableNumber = this.getAttribute("data-table");
                const quantityInput = document.querySelector(`.quantity[data-id='${itemId}']`);
                const quantity = quantityInput ? parseInt(quantityInput.value, 10) : 1;

                fetch("/order/add", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ itemId, quantity, tableNumber })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("‚úÖ ƒê√£ th√™m v√†o gi·ªè h√†ng cho b√†n " + tableNumber + "!");
                    } else {
                        alert("‚ùå Th√™m th·∫•t b·∫°i: " + data.error);
                    }
                })
                .catch(error => console.error("‚ùå L·ªói khi th√™m v√†o gi·ªè h√†ng:", error));
            });
        });
    }
});
</script>

<%- include('../partials/footer') %>