<%- include('../partials/header') %>

<style>
  .menu-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.2s;
  }

  .menu-card:hover {
      transform: scale(1.05);
  }

  .menu-card img {
      height: 150px;
      object-fit: cover;
  }

  .menu-card .card-body {
      text-align: center;
  }

  .cart-table th, .cart-table td {
      text-align: center;
      vertical-align: middle;
  }

  .cart-summary {
      font-weight: bold;
      font-size: 1.2rem;
  }
</style>

<div class="container mt-4">
  <div class="row">
    <!-- Danh s√°ch m√≥n ƒÉn -->
    <div class="col-md-8">
      <h3 class="mb-4">üìú Menu - <span id="selectedTable">Ch·ªçn b√†n</span></h3>
      <div class="row" id="menuContainer">
        <div class="col-12 text-danger">
          Vui l√≤ng ch·ªçn b√†n ƒë·ªÉ hi·ªÉn th·ªã menu.
        </div>
      </div>
    </div>

    <!-- Gi·ªè h√†ng -->
    <div class="col-md-4">
      <h3 class="mb-4">üõí Danh s√°ch g·ªçi m√≥n</h3>
      <table class="table table-bordered cart-table">
        <thead class="table-dark">
          <tr>
            <th>T√™n m√≥n</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>Th√†nh ti·ªÅn</th>
          </tr>
        </thead>
        <tbody id="cartItems">
          <tr>
            <td colspan="3" class="text-danger">Gi·ªè h√†ng tr·ªëng.</td>
          </tr>
        </tbody>
      </table>
      <div class="d-flex justify-content-between cart-summary">
        <span>T·ªïng ti·ªÅn:</span>
        <span id="totalPrice">0 VND</span>
      </div>
      <button class="btn w-100 mt-3" id="orderButton" style="background-color: #662c21; color: white;">Order</button>
    </div>
  </div>

  <!-- Ch·ªçn b√†n -->
  <div class="mt-5">
    <h4>ü™ë Ch·ªçn b√†n</h4>
    <div class="d-flex flex-wrap gap-2">
      <% for (let i = 1; i <= 12; i++) { %>
      <button class="btn btn-outline-primary table-btn" data-table="<%= i %>">
        B√†n <%= i %>
      </button>
      <% } %>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const menuContainer = document.getElementById("menuContainer");
    const cartItems = document.getElementById("cartItems");
    const totalPrice = document.getElementById("totalPrice");
    const orderButton = document.getElementById("orderButton");
    let cart = [];

    // X·ª≠ l√Ω ch·ªçn b√†n
    document.querySelectorAll(".table-btn").forEach((button) => {
      button.addEventListener("click", function () {
        const tableNumber = this.getAttribute("data-table");
        document.getElementById("selectedTable").innerText = `B√†n ${tableNumber}`;

        fetch(`/order/menu/${tableNumber}`)
          .then((response) => response.json())
          .then((data) => {
            renderMenu(data);
          })
          .catch((error) => console.error("L·ªói t·∫£i menu:", error));
      });
    });

    // Hi·ªÉn th·ªã menu
    function renderMenu(menuItems) {
      menuContainer.innerHTML = "";

      if (!Array.isArray(menuItems) || menuItems.length === 0) {
        menuContainer.innerHTML = `<div class="col-12 text-danger">‚ùå Kh√¥ng c√≥ m√≥n n√†o trong menu.</div>`;
        return;
      }

      menuItems.forEach((item) => {
        menuContainer.innerHTML += `
          <div class="col-md-4 mb-4">
            <div class="card menu-card">
              <img src="${item.image || '/public/image/default.jpg'}" class="card-img-top" alt="${item.name}">
              <div class="card-body">
                <h5 class="card-title">${item.name}</h5>
                <p class="card-text">${item.price.toLocaleString('vi-VN')} VND</p>
                <div class="d-flex justify-content-center">
                  <input type="number" class="form-control text-center quantity" min="1" value="1" data-id="${item._id}" style="width: 80px;">
                </div>
                <button class="btn btn-primary btn-sm mt-2 add-to-cart" data-id="${item._id}" data-name="${item.name}" data-price="${item.price}">
                  ‚ûï Th√™m
                </button>
              </div>
            </div>
          </div>`;
      });

      document.querySelectorAll(".add-to-cart").forEach((button) => {
        button.addEventListener("click", function () {
          const itemId = this.getAttribute("data-id");
          const quantityInput = document.querySelector(`.quantity[data-id='${itemId}']`);
          const quantity = quantityInput ? parseInt(quantityInput.value, 10) : 1;

          const item = menuItems.find((item) => item._id === itemId);
          if (item) {
            addToCart(item, quantity);
          }
        });
      });
    }

    // Th√™m m√≥n v√†o gi·ªè h√†ng
    function addToCart(item, quantity) {
      const existingItem = cart.find((cartItem) => cartItem._id === item._id);
      if (existingItem) {
        existingItem.quantity += quantity; // C·ªông d·ªìn s·ªë l∆∞·ª£ng n·∫øu m√≥n ƒë√£ c√≥ trong gi·ªè
      } else {
        cart.push({ ...item, quantity }); // Th√™m m√≥n m·ªõi v√†o gi·ªè
      }
      renderCart(); // C·∫≠p nh·∫≠t giao di·ªán gi·ªè h√†ng
    }

    // Hi·ªÉn th·ªã gi·ªè h√†ng
    function renderCart() {
      cartItems.innerHTML = ""; // X√≥a n·ªôi dung c≈© trong gi·ªè h√†ng
      let total = 0; // Bi·∫øn l∆∞u t·ªïng ti·ªÅn

      // Duy·ªát qua t·ª´ng m√≥n trong gi·ªè h√†ng
      cart.forEach((item) => {
        const itemTotal = item.price * item.quantity; // T√≠nh th√†nh ti·ªÅn cho t·ª´ng m√≥n 
        total += itemTotal; // C·ªông v√†o t·ªïng ti·ªÅn

        // Th√™m d√≤ng hi·ªÉn th·ªã m√≥n v√†o b·∫£ng gi·ªè h√†ng
        cartItems.innerHTML += `
          <tr>
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>${itemTotal.toLocaleString('vi-VN')} VND</td>
          </tr>`;
      });

      // N·∫øu gi·ªè h√†ng tr·ªëng, hi·ªÉn th·ªã th√¥ng b√°o
      if (cart.length === 0) {
        cartItems.innerHTML = `<tr><td colspan="3" class="text-danger">Gi·ªè h√†ng tr·ªëng.</td></tr>`;
      }

      // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn hi·ªÉn th·ªã
      totalPrice.textContent = `${total.toLocaleString('vi-VN')} VND`;
    }

    // X·ª≠ l√Ω n√∫t "Order"
    orderButton.addEventListener("click", function () {
      if (cart.length === 0) {
        alert("‚ùå Gi·ªè h√†ng tr·ªëng. Vui l√≤ng th√™m m√≥n!");
        return;
      }

      fetch("/order/submit", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ cart })
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert("‚úÖ ƒê·∫∑t m√≥n th√†nh c√¥ng!");
            cart = [];
            renderCart();
          } else {
            alert("‚ùå L·ªói khi ƒë·∫∑t m√≥n: " + data.error);
          }
        })
        .catch((error) => console.error("‚ùå L·ªói khi g·ª≠i ƒë∆°n h√†ng:", error));
    });
  });
</script>

<%- include('../partials/footer') %>